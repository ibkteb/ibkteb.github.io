<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>QR Stream Test Suite</title>
    <style>
        body {
            background: #1a1a2e;
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: #00ff88;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .pass {
            color: #00ff88;
        }

        .fail {
            color: #ff4757;
        }

        .log {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 12px;
        }

        canvas {
            border: 1px solid #333;
            margin: 10px;
        }

        .canvas-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸ“¡ QR Stream Test Suite</h1>
        <p>Tests the complete encode â†’ QR render â†’ jsQR decode â†’ receive pipeline</p>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-box">
                <div class="stat-value pass" id="passedTests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-box">
                <div class="stat-value fail" id="failedTests">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <div class="test-section">
            <h3>Test Controls</h3>
            <button class="btn btn-primary" id="runAll">â–¶ Run All Tests</button>
            <button class="btn btn-secondary" id="runUnit">Unit Tests Only</button>
            <button class="btn btn-secondary" id="runIntegration">Integration Tests Only</button>
            <button class="btn btn-secondary" id="clearLog">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>Visual Debug</h3>
            <div class="canvas-row" id="canvasRow"></div>
        </div>

        <div class="test-section">
            <h3>Test Log</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script src="qr-encoder.js"></script>
    <script src="qr-stream.js"></script>
    <script src="jsQR.min.js"></script>
    <script>
        const logEl = document.getElementById('log');
        const canvasRow = document.getElementById('canvasRow');
        let totalTests = 0, passedTests = 0, failedTests = 0;

        function log(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            logEl.appendChild(span);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('passedTests').textContent = passedTests;
            document.getElementById('failedTests').textContent = failedTests;
        }

        function pass(name) {
            totalTests++; passedTests++;
            log(`âœ… PASS: ${name}`, 'pass');
            updateStats();
        }

        function fail(name, reason) {
            totalTests++; failedTests++;
            log(`âŒ FAIL: ${name}`, 'fail');
            log(`   Reason: ${reason}`, 'fail');
            updateStats();
        }

        function resetStats() {
            totalTests = passedTests = failedTests = 0;
            updateStats();
            logEl.innerHTML = '';
            canvasRow.innerHTML = '';
        }

        // ========== UNIT TESTS ==========

        function testCRC16() {
            log('\n=== CRC-16 Test ===');
            const data = new Uint8Array([72, 101, 108, 108, 111]); // "Hello"
            const crc = QRStream.crc16(data);
            if (typeof crc === 'number' && crc > 0 && crc < 65536) {
                pass('CRC-16 returns valid value');
            } else {
                fail('CRC-16 returns valid value', `Got: ${crc}`);
            }

            // Same data should give same CRC
            const crc2 = QRStream.crc16(data);
            if (crc === crc2) {
                pass('CRC-16 is consistent');
            } else {
                fail('CRC-16 is consistent', `${crc} !== ${crc2}`);
            }
        }

        function testPacketEncodeDecode() {
            log('\n=== Packet Encode/Decode Test ===');
            const testData = new Uint8Array([1, 2, 3, 4, 5, 100, 200, 255]);
            const encoded = QRStream.encodePacket(0, 1, 0x03, testData);

            log(`Encoded packet: ${encoded.substring(0, 50)}...`);

            if (typeof encoded === 'string' && encoded.length > 0) {
                pass('encodePacket returns string');
            } else {
                fail('encodePacket returns string', `Got: ${typeof encoded}`);
            }

            const decoded = QRStream.decodePacket(encoded);
            if (decoded && !decoded.error) {
                pass('decodePacket returns valid object');
            } else {
                fail('decodePacket returns valid object', `Got: ${JSON.stringify(decoded)}`);
                return;
            }

            if (decoded.seq === 0) {
                pass('Sequence number preserved');
            } else {
                fail('Sequence number preserved', `Expected 0, got ${decoded.seq}`);
            }

            if (decoded.total === 1) {
                pass('Total count preserved');
            } else {
                fail('Total count preserved', `Expected 1, got ${decoded.total}`);
            }

            if (decoded.flags === 0x03) {
                pass('Flags preserved');
            } else {
                fail('Flags preserved', `Expected 3, got ${decoded.flags}`);
            }

            // Check data integrity
            const dataMatch = decoded.data.length === testData.length &&
                decoded.data.every((v, i) => v === testData[i]);
            if (dataMatch) {
                pass('Data integrity preserved');
            } else {
                fail('Data integrity preserved',
                    `Expected [${[...testData]}], got [${[...decoded.data]}]`);
            }
        }

        function testInvalidPackets() {
            log('\n=== Invalid Packet Test ===');

            // Empty string
            if (QRStream.decodePacket('') === null) {
                pass('Rejects empty string');
            } else {
                fail('Rejects empty string', 'Should return null');
            }

            // Random string (not Base64)
            if (QRStream.decodePacket('Hello World') === null) {
                pass('Rejects non-Base64 string');
            } else {
                fail('Rejects non-Base64 string', 'Should return null');
            }

            // Valid Base64 but wrong magic
            const wrongMagic = btoa('XX\x00\x00\x00\x01\x00\x00\x00hello');
            if (QRStream.decodePacket(wrongMagic) === null) {
                pass('Rejects wrong magic bytes');
            } else {
                fail('Rejects wrong magic bytes', 'Should return null');
            }
        }

        // ========== INTEGRATION TESTS ==========

        function testSenderReceiver() {
            log('\n=== Sender/Receiver Integration Test ===');
            const testText = 'Hello, QR Stream! This is a test message.';

            const sender = new QRStream.Sender(testText, { chunkSize: 20 });
            log(`Sender created: ${sender.totalPackets} packets for ${testText.length} bytes`);

            const receiver = new QRStream.Receiver();

            // Simulate sending all packets
            for (let i = 0; i < sender.totalPackets; i++) {
                const packet = sender.getPacket(i);
                const result = receiver.receive(packet);
                log(`Packet ${i}: accepted=${result.accepted}`);
                if (!result.accepted) {
                    fail('All packets accepted', `Packet ${i} rejected: ${result.reason}`);
                    return;
                }
            }
            pass('All packets accepted');

            if (receiver.isComplete()) {
                pass('Receiver reports complete');
            } else {
                fail('Receiver reports complete', `Missing: ${receiver.getMissingSequences()}`);
                return;
            }

            const reassembled = receiver.reassemble();
            const decoded = new TextDecoder().decode(reassembled);
            if (decoded === testText) {
                pass('Data integrity: exact match');
            } else {
                fail('Data integrity: exact match', `Expected "${testText}", got "${decoded}"`);
            }
        }

        async function testFullQRPipeline() {
            log('\n=== Full QR Pipeline Test (encode â†’ render â†’ jsQR â†’ decode) ===');

            const testText = 'QR Stream Pipeline Test!';
            const sender = new QRStream.Sender(testText, { chunkSize: 100 });
            const receiver = new QRStream.Receiver();

            log(`Testing ${sender.totalPackets} packet(s)...`);

            // Create a canvas for rendering
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            for (let i = 0; i < sender.totalPackets; i++) {
                const packetString = sender.getPacket(i);
                log(`\nPacket ${i}: ${packetString.length} chars (Base64)`);

                // Render to QR code
                try {
                    const qrData = QREncoder.generate(packetString, 'M');
                    QREncoder.renderToCanvas(qrData, canvas, { scale: 4, margin: 4 });
                    log(`  Rendered: ${canvas.width}x${canvas.height} px, QR version: ${(qrData.size - 17) / 4}`);

                    // Add to visual debug
                    const debugCanvas = document.createElement('canvas');
                    debugCanvas.width = canvas.width;
                    debugCanvas.height = canvas.height;
                    debugCanvas.title = `Packet ${i}`;
                    debugCanvas.getContext('2d').drawImage(canvas, 0, 0);
                    canvasRow.appendChild(debugCanvas);

                    // Decode with jsQR
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);

                    if (!code) {
                        fail(`jsQR detects packet ${i}`, 'jsQR returned null');
                        continue;
                    }
                    log(`  jsQR: detected ${code.data.length} chars`);

                    // Compare what jsQR got to what we encoded
                    if (code.data === packetString) {
                        pass(`Packet ${i}: QR round-trip exact match`);
                    } else {
                        log(`  Expected: ${packetString.substring(0, 30)}...`);
                        log(`  Got:      ${code.data.substring(0, 30)}...`);
                        fail(`Packet ${i}: QR round-trip`, 'Data mismatch after jsQR');
                    }

                    // Feed to receiver
                    const result = receiver.receive(code.data);
                    log(`  Receiver: ${JSON.stringify(result)}`);
                    if (!result.accepted) {
                        fail(`Packet ${i}: Receiver accepts`, result.reason);
                    }

                } catch (e) {
                    fail(`Packet ${i}: No exception`, e.message);
                }
            }

            // Final check
            if (receiver.isComplete()) {
                const reassembled = receiver.reassemble();
                const decoded = new TextDecoder().decode(reassembled);
                if (decoded === testText) {
                    pass('Full pipeline: data integrity');
                } else {
                    fail('Full pipeline: data integrity', `"${decoded}" !== "${testText}"`);
                }
            } else {
                fail('Full pipeline: complete', `Missing: ${receiver.getMissingSequences()}`);
            }
        }

        async function testLargerData() {
            log('\n=== Larger Data Test (multi-packet) ===');

            // Generate larger text
            const testText = 'Lorem ipsum dolor sit amet. '.repeat(20);
            log(`Test data: ${testText.length} bytes`);

            const sender = new QRStream.Sender(testText, { chunkSize: 100 });
            const receiver = new QRStream.Receiver();

            log(`Split into ${sender.totalPackets} packets`);

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let allOk = true;

            for (let i = 0; i < sender.totalPackets; i++) {
                const packetString = sender.getPacket(i);
                const qrData = QREncoder.generate(packetString, 'M');
                QREncoder.renderToCanvas(qrData, canvas, { scale: 4, margin: 4 });

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (!code || code.data !== packetString) {
                    log(`Packet ${i}: MISMATCH`);
                    allOk = false;
                } else {
                    receiver.receive(code.data);
                }
            }

            if (allOk && receiver.isComplete()) {
                const reassembled = receiver.reassemble();
                const decoded = new TextDecoder().decode(reassembled);
                if (decoded === testText) {
                    pass(`Multi-packet (${sender.totalPackets} packets): success`);
                } else {
                    fail(`Multi-packet: data match`, 'Content mismatch');
                }
            } else {
                fail('Multi-packet: complete', `allOk=${allOk}, complete=${receiver.isComplete()}`);
            }
        }

        // ========== RUN TESTS ==========

        async function runUnitTests() {
            log('========== UNIT TESTS ==========');
            testCRC16();
            testPacketEncodeDecode();
            testInvalidPackets();
        }

        async function runIntegrationTests() {
            log('========== INTEGRATION TESTS ==========');
            testSenderReceiver();
            await testFullQRPipeline();
            await testLargerData();
        }

        async function runAllTests() {
            resetStats();
            log('Starting QR Stream Test Suite...\n');
            await runUnitTests();
            await runIntegrationTests();
            log('\n========== COMPLETE ==========');
            log(`Total: ${totalTests}, Passed: ${passedTests}, Failed: ${failedTests}`);
        }

        document.getElementById('runAll').onclick = runAllTests;
        document.getElementById('runUnit').onclick = () => { resetStats(); runUnitTests(); };
        document.getElementById('runIntegration').onclick = () => { resetStats(); runIntegrationTests(); };
        document.getElementById('clearLog').onclick = resetStats;
    </script>
</body>

</html>